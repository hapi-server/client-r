library(RJSONIO)
library("stringr")
library(data.table)
hapi <- function(...) {

  args <- list(...)
  if (length(args) == 0) {
    url <- "https://github.com/hapi-server/servers/raw/master/all.txt"
    print(paste("hapi(): Downloading", url, sep=" "))
    servers <- data.table::fread(url, header=FALSE)
    return(servers[[1]])
  }
  if (length(args) == 1) {
    url <- paste(args[[1]], "catalog", sep="")
    print(paste("hapi(): Downloading", url, sep=" "))
    catalog <- fromJSON(url)
    return(catalog)
  }
  if (length(args) == 2) {
    url <- paste(args[[1]], "info?id=", args[[2]], sep="")
    print(paste("hapi(): Downloading", url, sep=" "))
    info <- fromJSON(url)
    return(info)
  }
  if (length(args) == 3) {
    url <- paste(args[[1]], "info?id=", args[[2]], "&parameters=", args[[3]], sep="")
    print(paste("hapi(): Downloading", url, sep=" "))
    info <- fromJSON(url)
    return(info)
  }
  if (length(args) == 5) {
 
    meta <- hapi(args[[1]], args[[2]], args[[3]])
    
    url <- paste(args[[1]], "data?id=", args[[2]], "&parameters=", args[[3]], "&time.min=", args[[4]], "&time.max=", args[[5]], sep="")
    print(paste("hapi(): Downloading", url, sep=" "))
    csv <- data.table::fread(url)
    
    parameters <- unlist(strsplit(paste("Time", args[[3]], sep=","), ","))
    
    # Put each column from csv into individual list element
    data <- list(csv[, 1])
    
    # Number of rows (time values)
    Nr <- nrow(data[[1]])
    
    k = 2
    for (i in 2:length(parameters)) {
      if ("size" %in% names(meta$parameters[[i]])) {
        size <- meta$parameters[[i]]$size
      } else {
        size <- 1
      }
      
      
      # Number of columns of parameter
      Nc <- prod(size)
      
      print(paste("Extracting columns ", k, "through", (k+Nc-1)), sep="")
      
      
      size <- append(Nr, size)
        

 
        
      print(paste("Extracting columns ", k, "through", (k+Nc-1)), sep="")
        
        # Extract columns and re-shape 
      data2 <- data.matrix(as.factor(unlist((csv[, k:(k+Nc-1)]))))
      dim(data2) <- size
        
        
        # Add to named list 
      data <- c(data, list(data2))
      
      k <- k + Nc
      
    }
    # Add names based on request parameters
    # If args[3] = "param1,param2", the following is equivalent to 
    # e.g., names(data) <- c("Time", "param1", "param2")
    names(data) <- c(parameters)
    
    return(data)
  }
}
